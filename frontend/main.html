<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TradeFX Terminal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
        color: #0f172a;
        background-color: #f1f5f9;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: #eef2ff;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      }

      nav {
        display: flex;
        gap: 1rem;
      }

      nav button {
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 0.75rem 0.5rem;
        font-size: 1rem;
        color: #475569;
        cursor: pointer;
      }

      nav button.active {
        border-bottom-color: #2563eb;
        color: #2563eb;
      }

      main {
        flex: 1;
        padding: 2rem;
        display: none;
      }

      main.active {
        display: block;
      }

      .grid {
        display: grid;
        gap: 1.5rem;
      }

      .card {
        background: #fff;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 20px 50px rgba(15, 23, 42, 0.08);
      }

      .chart-card {
        padding: 1.5rem;
      }

      #main-chart {
        width: 100%;
        height: 400px;
      }

      .controls {
        display: inline-flex;
        gap: 0.5rem;
        background: #f1f5f9;
        padding: 0.3rem;
        border-radius: 999px;
      }

      .controls button {
        border: none;
        border-radius: 999px;
        background: transparent;
        color: #475569;
        padding: 0.4rem 0.9rem;
      }

      .controls button.active {
        background: #2563eb;
        color: #fff;
      }

      /* New styles for logout button */
      .logout-btn {
        background: #ef4444;
        color: #fff;
        border: none;
        border-radius: 999px;
        padding: 0.6rem 1.5rem;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .logout-btn:hover {
        background: #dc2626;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>TradeFX Terminal</h1>
      <nav>
        <button data-section="deposit" class="active">Deposit</button>
        <button data-section="trade">Trade</button>
        <button data-section="wallet">View Wallet</button>
      </nav>
      <!-- New Log out button in top right corner -->
      <button class="logout-btn" id="logout-btn">Log out</button>
    </header>

    <main id="deposit" class="active">
      <div class="card">
        <h2>Deposit Funds</h2>
        <p>Connect your wallet in the app to deposit funds securely.</p>
      </div>
    </main>

    <main id="trade">
      <div class="grid">
        <article class="card chart-card">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;">
            <div>
              <h2 id="trade-pair">USDT d EURC</h2>
              <p id="trade-price" style="color:#94a3b8;margin:0;">Loading9</p>
            </div>
            <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
              <div class="controls">
                <button data-pair="USDT_EURC" class="active">USDT / EURC</button>
                <button data-pair="EURC_USDT">EURC / USDT</button>
              </div>
              <div class="controls">
                <button data-type="line" class="active">Line</button>
                <button data-type="candles">Candles</button>
              </div>
            </div>
          </div>
          <div id="main-chart"></div>
        </article>
        <article class="card">
          <h2>Trade Ticket</h2>
          <form class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
            <label>Amount (USDT)
              <input type="number" placeholder="0.00" style="width:100%;padding:0.75rem;border-radius:0.75rem;border:1px solid rgba(148,163,184,0.6);" />
            </label>
            <label>Leverage
              <input type="number" min="1" max="50" value="5" style="width:100%;padding:0.75rem;border-radius:0.75rem;border:1px solid rgba(148,163,184,0.6);" />
            </label>
            <label>Order Type
              <select id="order-type" style="width:100%;padding:0.75rem;border-radius:0.75rem;border:1px solid rgba(148,163,184,0.6);">
                <option value="Market">Market</option>
                <option value="Limit">Limit</option>
              </select>
            </label>
            <label id="limit-price-label" style="display:none;">Limit Price
              <input
                type="number"
                step="0.0001"
                placeholder="Enter limit price"
                style="width:100%;padding:0.75rem;border-radius:0.75rem;border:1px solid rgba(148,163,184,0.6);"
              />
            </label>
          </form>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0.75rem;margin-top:1.5rem;">
            <button style="background:#22c55e;color:#fff;border:none;padding:0.9rem;border-radius:0.9rem;">Buy</button>
            <button style="background:#ef4444;color:#fff;border:none;padding:0.9rem;border-radius:0.9rem;">Sell</button>
          </div>
        </article>
      </div>
    </main>

    <main id="wallet">
      <div class="card">
        <h2>Wallet Overview</h2>
        <p>Use the in-app wallet tab to view balances and manage connections.</p>
      </div>
    </main>

    <script type="module">
      const sections = document.querySelectorAll('main');
      document.querySelectorAll('nav button').forEach((button) => {
        button.addEventListener('click', () => {
          document.querySelector('nav button.active').classList.remove('active');
          button.classList.add('active');
          sections.forEach((section) => section.classList.remove('active'));
          document.getElementById(button.dataset.section).classList.add('active');
        });
      });

      // Enhanced logout functionality
      const logoutBtn = document.getElementById('logout-btn');
      logoutBtn.addEventListener('click', async () => {
        try {
          // Handle MetaMask and other EIP-1193 wallets
          if (window.ethereum) {
            try {
              // Attempt to revoke permissions (works with some wallets like MetaMask)
              await window.ethereum.request({
                method: 'wallet_revokePermissions',
                params: [{ eth_accounts: {} }],
              });
            } catch (error) {
              // Some wallets don't support revokePermissions, that's okay
              console.log('Wallet permissions revoke not supported or failed:', error);
            }
          }

          // Clear Thirdweb connection data (if using Thirdweb)
          try {
            // Clear Thirdweb-specific storage keys
            const thirdwebKeys = Object.keys(localStorage).filter(key => 
              key.includes('thirdweb') || 
              key.includes('wallet') || 
              key.includes('connect') ||
              key.includes('wc@2') // WalletConnect v2
            );
            thirdwebKeys.forEach(key => localStorage.removeItem(key));
          } catch (error) {
            console.log('Error clearing Thirdweb data:', error);
          }

          // Clear all local storage and session storage
          localStorage.clear();
          sessionStorage.clear();

          // Clear any indexedDB data related to wallets (WalletConnect uses this)
          try {
            if ('indexedDB' in window) {
              const databases = await indexedDB.databases();
              databases.forEach(db => {
                if (db.name && (db.name.includes('wallet') || db.name.includes('wc'))) {
                  indexedDB.deleteDatabase(db.name);
                }
              });
            }
          } catch (error) {
            console.log('Error clearing IndexedDB:', error);
          }

          // Small delay to ensure cleanup completes
          await new Promise(resolve => setTimeout(resolve, 100));

          // Redirect to index.html
          window.location.href = 'index.html';
        } catch (error) {
          console.error('Logout error:', error);
          // Even if there's an error, still redirect
          window.location.href = 'index.html';
        }
      });

      const orderTypeSelect = document.getElementById('order-type');
      const limitPriceLabel = document.getElementById('limit-price-label');
      const limitPriceInput = limitPriceLabel.querySelector('input');

      const toggleLimitPrice = () => {
        if (orderTypeSelect.value === 'Limit') {
          limitPriceLabel.style.display = 'block';
          limitPriceInput.required = true;
        } else {
          limitPriceLabel.style.display = 'none';
          limitPriceInput.required = false;
          limitPriceInput.value = '';
        }
      };

      orderTypeSelect.addEventListener('change', toggleLimitPrice);
      toggleLimitPrice();

      const { createChart, CrosshairMode } = await import('https://unpkg.com/lightweight-charts@5.0.9/dist/lightweight-charts.standalone.production.js');

      const chartContainer = document.getElementById('main-chart');
      const chart = createChart(chartContainer, {
        layout: {
          background: { type: 'solid', color: 'transparent' },
          textColor: '#0f172a',
        },
        grid: {
          horzLines: { color: 'rgba(15,23,42,0.1)' },
          vertLines: { color: 'rgba(15,23,42,0.1)' },
        },
        crosshair: { mode: CrosshairMode.Normal },
        width: chartContainer.clientWidth,
        height: chartContainer.clientHeight,
      });

      const resizeObserver = new ResizeObserver((entries) => {
        for (const entry of entries) {
          chart.applyOptions({
            width: entry.contentRect.width,
            height: entry.contentRect.height,
          });
        }
      });
      resizeObserver.observe(chartContainer);

      let selectedPair = 'USDT_EURC';
      let chartType = 'line';
      let series = chart.addAreaSeries({
        topColor: 'rgba(37,99,235,0.4)',
        bottomColor: 'rgba(37,99,235,0.05)',
        lineColor: '#2563eb',
        lineWidth: 2,
      });

      const buildCandles = (lineData) => {
        const candles = [];
        for (let i = 0; i < lineData.length - 3; i += 4) {
          const chunk = lineData.slice(i, i + 4);
          candles.push({
            time: chunk[0].time,
            open: chunk[0].value,
            high: Math.max(...chunk.map((point) => point.value)),
            low: Math.min(...chunk.map((point) => point.value)),
            close: chunk[chunk.length - 1].value,
          });
        }
        return candles;
      };

      const loadTradeChart = async () => {
        document.getElementById('trade-price').textContent = 'Loading9';
        const response = await fetch('https://api.coingecko.com/api/v3/coins/tether/market_chart?vs_currency=eur&days=3&interval=hourly');
        const data = await response.json();
        const prices = (data.prices || []).map(([timestamp, value]) => ({
          time: Math.floor(timestamp / 1000),
          value: selectedPair === 'USDT_EURC' ? value : 1 / value,
        }));
        const latest = prices.at(-1)?.value;
        document.getElementById('trade-pair').textContent = selectedPair === 'USDT_EURC' ? 'USDT d EURC' : 'EURC d USDT';
        if (latest) {
          document.getElementById('trade-price').textContent = latest.toFixed(4);
        }

        if (series) {
          chart.removeSeries(series);
        }

        if (chartType === 'line') {
          series = chart.addAreaSeries({
            topColor: 'rgba(37,99,235,0.4)',
            bottomColor: 'rgba(37,99,235,0.05)',
            lineColor: '#2563eb',
            lineWidth: 2,
          });
          series.setData(prices);
        } else {
          series = chart.addCandlestickSeries({
            upColor: '#22c55e',
            downColor: '#ef4444',
            borderDownColor: '#ef4444',
            borderUpColor: '#22c55e',
            wickDownColor: '#ef4444',
            wickUpColor: '#22c55e',
          });
          series.setData(buildCandles(prices));
        }

        chart.timeScale().fitContent();
      };

      document.querySelectorAll('[data-pair]').forEach((button) => {
        button.addEventListener('click', () => {
          document.querySelectorAll('[data-pair]').forEach((btn) => btn.classList.remove('active'));
          button.classList.add('active');
          selectedPair = button.dataset.pair;
          loadTradeChart();
        });
      });

      document.querySelectorAll('[data-type]').forEach((button) => {
        button.addEventListener('click', () => {
          document.querySelectorAll('[data-type]').forEach((btn) => btn.classList.remove('active'));
          button.classList.add('active');
          chartType = button.dataset.type;
          loadTradeChart();
        });
      });

      loadTradeChart();
      setInterval(loadTradeChart, 60_000);
    </script>
  </body>
</html>